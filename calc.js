function BaseValue(fighter, round, isSuper) {
    let table = [
        [0x30, 0x24, 0x18, 0x18],
        [0x34, 0x28, 0x18, 0x18],
        [0x30, 0x28, 0x1C, 0x16],
        [0x38, 0x34, 0x28, 0x26],
        [0x34, 0x28, 0x20, 0x19],
        [0x34, 0x30, 0x20, 0x1A],
        [0x38, 0x32, 0x24, 0x1C],
        [0x28, 0x60, 0x1C, 0x48],
        [0x38, 0x30, 0x2C, 0x20],
        [0x34, 0x34, 0x2C, 0x20],
        [0x34, 0x2C, 0x28, 0x20],
        [0x3C, 0x3C, 0x2C, 0x28],
        [0x34, 0x2C, 0x28, 0x24],
        [0x28, 0x2C, 0x20, 0x20],
        [0x38, 0x38, 0x28, 0x2C],
        [0x34, 0x34, 0x26, 0x24]
    ];
    let j = round;
    if (isSuper) {
        j += 2;
    }
    return table[fighter][j];
};

function TimeValue(fighter, seconds) {
    let table = [
        [0x04, 0x00, 0x0a, 0x06, 0x10, 0x10, 0x1a, 0x18, 0x24, 0x24, 0x33, 0x34, 0x51, 0x3c, 0xb5, 0x44],
        [0x06, 0x00, 0x0e, 0x04, 0x16, 0x08, 0x1a, 0x18, 0x29, 0x20, 0x3d, 0x28, 0x5b, 0x30, 0xb5, 0x38],
        [0x04, 0x00, 0x08, 0x08, 0x0d, 0x0e, 0x13, 0x18, 0x1f, 0x20, 0x2e, 0x28, 0x47, 0x30, 0xb5, 0x38],
        [0x04, 0x00, 0x09, 0x08, 0x10, 0x0e, 0x18, 0x14, 0x22, 0x1a, 0x2e, 0x20, 0x3d, 0x28, 0xb5, 0x30],
        [0x04, 0x00, 0x09, 0x04, 0x0e, 0x08, 0x15, 0x18, 0x24, 0x20, 0x33, 0x28, 0x4c, 0x30, 0xb5, 0x38],
        [0x04, 0x00, 0x08, 0x05, 0x0d, 0x0a, 0x12, 0x10, 0x1c, 0x1a, 0x2e, 0x22, 0x47, 0x2c, 0xb5, 0x38],
        [0x04, 0x00, 0x09, 0x06, 0x0f, 0x0a, 0x15, 0x1a, 0x1f, 0x24, 0x2e, 0x2c, 0x42, 0x38, 0xb5, 0x40],
        [0x06, 0x00, 0x0b, 0x06, 0x15, 0x0a, 0x1f, 0x0e, 0x29, 0x12, 0x38, 0x18, 0x47, 0x22, 0xb5, 0x28],
        [0x04, 0x00, 0x09, 0x10, 0x10, 0x18, 0x1a, 0x1e, 0x29, 0x24, 0x3d, 0x2c, 0x5b, 0x32, 0xb5, 0x38],
        [0x04, 0x00, 0x09, 0x0c, 0x10, 0x14, 0x1a, 0x1a, 0x29, 0x20, 0x3d, 0x28, 0x5b, 0x2c, 0xb5, 0x34],
        [0x04, 0x00, 0x09, 0x06, 0x0e, 0x0a, 0x15, 0x0e, 0x1f, 0x12, 0x2e, 0x16, 0x3d, 0x1e, 0xb5, 0x26],
        [0x04, 0x00, 0x08, 0x0c, 0x0d, 0x14, 0x13, 0x1a, 0x1a, 0x1e, 0x24, 0x22, 0x33, 0x28, 0xb5, 0x34],
        [0x04, 0x00, 0x09, 0x0e, 0x10, 0x14, 0x1a, 0x19, 0x24, 0x1e, 0x33, 0x24, 0x4c, 0x2a, 0xb5, 0x30],
        [0x04, 0x00, 0x09, 0x08, 0x10, 0x0e, 0x1a, 0x12, 0x24, 0x18, 0x38, 0x1e, 0x4c, 0x24, 0xb5, 0x2a],
        [0x04, 0x00, 0x09, 0x06, 0x0e, 0x0c, 0x15, 0x12, 0x1f, 0x18, 0x29, 0x20, 0x3d, 0x2c, 0xb5, 0x34],
        [0x04, 0x00, 0x09, 0x0a, 0x0e, 0x12, 0x13, 0x18, 0x1a, 0x1e, 0x24, 0x24, 0x3d, 0x2c, 0xb5, 0x34]
    ];
    let arr = table[fighter];
    for (let i = 0; i < arr.length; i += 2) {
        if (seconds < arr[i]) {
            return arr[i + 1];
        }
    }
};

function KnockoutThreshold(fighter) {
    let table = [
        0x28,
        0x23,
        0x26,
        0x24,
        0x22,
        0x24,
        0x27,
        0x1E,
        0x28,
        0x24,
        0x1C,
        0x2C,
        0x27,
        0x1C,
        0x20,
        0x28
    ];
    return table[fighter];
};

function Refill(fighter, round, roundSeconds, fighterHP, isSuper, totalDamageTaken) {
    const threshold = KnockoutThreshold(fighter);
    const base = BaseValue(fighter, round, isSuper);
    const time = TimeValue(fighter, roundSeconds);
    let v = base + time + Math.floor(totalDamageTaken / 4) + Math.floor(fighterHP / 4) - threshold;
    if (v >= 0x51) {
        return 0x50;
    }
    return v;
};

const fighterEl = document.querySelector("#fighter");
const roundEl = document.querySelector("#round");
const durationEl = document.querySelector("#duration");
const fighterHPEl = document.querySelector("#fighter-hp");
const damageEl = document.querySelector("#damage");
const superEl = document.querySelector("#super");
const refillEl = document.querySelector("#refill");

function Update() {
    let fighter = fighterEl.value = parseInt(fighterEl.value) || 0;
    let round = roundEl.value = parseInt(roundEl.value) || 0;
    let duration = durationEl.value = Math.max(0, Math.min(180, parseInt(durationEl.value))) || 0;
    let fighterHP = fighterHPEl.value = Math.max(0, Math.min(80, parseInt(fighterHPEl.value))) || 0;
    let damage = damageEl.value = Math.max(0, Math.min(80, parseInt(damageEl.value))) || 0;
    let isSuper = superEl.checked = superEl.checked || false;
    let refill = Refill(fighter, round, duration, fighterHP, isSuper, damage);
    refillEl.innerText = `${refill} ${refill <= 0 ? "(Knockout)" : ""}`;
};

[fighterEl, roundEl, durationEl, fighterHPEl, damageEl, superEl].forEach((el) => {
    el.addEventListener("change", Update);
    el.addEventListener("input", Update);
});

Update();
